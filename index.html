<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Public Dashboard - Expense Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-color: #f8f9fa;
      }
      .chart-card {
        margin-bottom: 2rem;
      }
      .footer {
        padding: 1rem 0;
        background-color: #e9ecef;
        text-align: center;
        font-size: 0.9rem;
        color: #6c757d;
      }
      .dashboard-title {
        font-weight: bold;
        text-align: center;
        margin-bottom: 2rem;
      }
      .card-title {
        font-weight: 600;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">Expense Tracker</a>
        <div class="ms-auto">
          <a href="login.html" class="btn btn-outline-light me-2">Login</a>
          <a href="register.html" class="btn btn-light">Register</a>
        </div>
      </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="container my-5">
      <h3 class="dashboard-title">ðŸ“Š Public Dashboard (Example Data)</h3>

      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="card text-white bg-success shadow-sm">
            <div class="card-body">
              <h6 class="card-title">Total Income</h6>
              <p id="totalIncome" class="fs-4 mb-0">â‚±0.00</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-white bg-danger shadow-sm">
            <div class="card-body">
              <h6 class="card-title">Total Expense</h6>
              <p id="totalExpense" class="fs-4 mb-0">â‚±0.00</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-white bg-primary shadow-sm">
            <div class="card-body">
              <h6 class="card-title">Net Balance</h6>
              <p id="netBalance" class="fs-4 mb-0">â‚±0.00</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Income vs Expense Chart -->
      <div class="card chart-card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">ðŸ“ˆ Income vs Expense</h5>
          <canvas id="incomeExpenseChart"></canvas>
        </div>
      </div>

      <!-- Monthly Trends -->
      <div class="card chart-card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">ðŸ“… Monthly Trends</h5>
          <canvas id="monthlyTrendsChart"></canvas>
        </div>
      </div>

      <!-- Category Trends -->
      <div class="card chart-card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">ðŸ“‚ Category Trends</h5>
          <div id="categoryTrendCharts"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <span>Â© 2025 Expense Tracker. All rights reserved.</span>
      </div>
    </footer>

    <!-- Scripts -->
    <script>
      const API_BASE =
        "https://markneilcordero.com/jquery-expense-tracker/public/api";
      let totalIncome = 0;
      let totalExpense = 0;

      function updateNetBalance() {
        const net = totalIncome - totalExpense;
        $("#netBalance").text("â‚±" + parseFloat(net).toFixed(2));
      }

      function renderCharts(income, expense, trends) {
        new Chart(
          document.getElementById("incomeExpenseChart").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: ["Income", "Expense"],
              datasets: [
                {
                  label: "Amount (â‚±)",
                  data: [income, expense],
                  backgroundColor: ["#198754", "#dc3545"],
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true },
              },
            },
          }
        );

        new Chart(
          document.getElementById("monthlyTrendsChart").getContext("2d"),
          {
            type: "line",
            data: {
              labels: trends.labels,
              datasets: [
                {
                  label: "Income",
                  data: trends.income,
                  borderColor: "#198754",
                  backgroundColor: "rgba(25,135,84,0.2)",
                  fill: true,
                  tension: 0.4,
                },
                {
                  label: "Expense",
                  data: trends.expense,
                  borderColor: "#dc3545",
                  backgroundColor: "rgba(220,53,69,0.2)",
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true },
              },
            },
          }
        );
      }

      function loadCategoryTrends() {
        $.ajax({
          url: `${API_BASE}/analytics/public-category-trends`,
          method: "GET",
          headers: { Accept: "application/json" },
          success: function (res) {
            const container = $("#categoryTrendCharts");
            container.empty();
            res.datasets.forEach((dataset, index) => {
              const canvasId = `catTrendChart${index}`;
              container.append(`
                <div class="mb-4">
                  <h6 class="mb-2">${dataset.label}</h6>
                  <canvas id="${canvasId}" height="100"></canvas>
                </div>
              `);
              new Chart(document.getElementById(canvasId).getContext("2d"), {
                type: "line",
                data: {
                  labels: res.labels,
                  datasets: [
                    {
                      label: dataset.label,
                      data: dataset.data,
                      borderColor: "#0d6efd",
                      backgroundColor: "rgba(13,110,253,0.2)",
                      fill: true,
                      tension: 0.4,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  scales: {
                    y: { beginAtZero: true },
                  },
                },
              });
            });
          },
          error: function () {
            console.error("Failed to load public category trends.");
          },
        });
      }

      $(document).ready(function () {
        $.ajax({
          url: `${API_BASE}/analytics/public-summary`,
          method: "GET",
          headers: { Accept: "application/json" },
          success: function (response) {
            totalIncome = response.total_income || 0;
            totalExpense = response.total_expense || 0;

            $("#totalIncome").text("â‚±" + parseFloat(totalIncome).toFixed(2));
            $("#totalExpense").text("â‚±" + parseFloat(totalExpense).toFixed(2));
            updateNetBalance();

            $.ajax({
              url: `${API_BASE}/analytics/public-monthly-trends`,
              method: "GET",
              headers: { Accept: "application/json" },
              success: function (monthlyData) {
                renderCharts(totalIncome, totalExpense, monthlyData);
              },
              error: function () {
                console.error("Failed to load public monthly trends.");
              },
            });

            loadCategoryTrends();
          },
          error: function () {
            console.error("Failed to load public summary.");
          },
        });
      });
    </script>
  </body>
</html>
